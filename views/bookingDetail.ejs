<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Booking Details</title>

  <!-- AdminLTE + Bootstrap 4 -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Your custom admin CSS -->
  <link rel="stylesheet" href="/css/admin.css">
</head>

<body class="hold-transition sidebar-mini">
  <div class="wrapper">
    <%- include('sidebar') %>

    <div class="content-wrapper">
      <!-- Header with Back button -->
      <div class="content-header py-2">
        <div class="container-fluid d-flex justify-content-between align-items-center">
          <h1 class="m-0">Booking Details</h1>
          <a href="/admin/bookings" class="btn btn-secondary btn-sm">
            <i class="fas fa-arrow-left mr-1"></i>Back to list
          </a>
        </div>
      </div>

      <section class="content pt-0">
        <div class="container-fluid">
          <% if (error && error.length) { %>
            <div class="alert alert-danger mb-2"><%= error[0] %></div>
          <% } %>

          <div class="card">
            <div class="card-body">
              <div class="row">
                <!-- Icon -->
                <div class="col-md-3 text-center mb-3">
                  <div class="bg-light border rounded-circle d-flex align-items-center justify-content-center"
                       style="width:150px; height:150px;">
                    <i class="fas fa-clipboard-list text-muted" style="font-size:72px;"></i>
                  </div>
                </div>

                <!-- Booking Info -->
                <div class="col-md-9">
                  <table class="table table-bordered mb-0">
                    <tr>
                      <th style="width:180px;">Booking ID</th>
                      <td><%= booking._id %></td>
                    </tr>
                    <tr>
                      <th>Patient</th>
                      <td><%= booking.patient.fullName %></td>
                    </tr>
                    <tr>
                      <th>Driver</th>
                      <td><%= booking.driver?.fullName || 'Unassigned' %></td>
                    </tr>
                    <tr>
                      <th>Vehicle</th>
                      <td><%= booking.ambulance?.vehicleNumber || 'â€”' %></td>
                    </tr>
                    <tr>
                      <th>OTP</th>
                      <td><%= booking.otp %></td>
                    </tr>
                    <tr>
                      <th>Status</th>
                      <td>
                        <% 
                          let cls = 'badge-secondary';
                          switch(booking.status) {
                            case 'assigned':     cls='badge-info';    break;
                            case 'arrived':      cls='badge-primary'; break;
                            case 'ride_started': cls='badge-warning'; break;
                            case 'completed':    cls='badge-success'; break;
                            case 'cancelled':    cls='badge-danger';  break;
                          }
                        %>
                        <span class="badge <%= cls %>">
                          <%= booking.status.replace('_',' ') %>
                        </span>
                      </td>
                    </tr>
                    <tr>
                      <th>Pickup Address</th>
                      <td><%= booking.pickupAddress %></td>
                    </tr>
                    <tr>
                      <th>Drop Address</th>
                      <td><%= booking.dropAddress %></td>
                    </tr>
                    <tr>
                      <th>Requested At</th>
                      <td>
                        <%= booking.createdAt
                              ? new Date(booking.createdAt).toLocaleString('en-GB',{
                                  day:'2-digit', month:'short', year:'numeric',
                                  hour:'2-digit', minute:'2-digit'
                                })
                              : 'N/A' %>
                      </td>
                    </tr>
                    <tr>
                      <th>Last Updated</th>
                      <td>
                        <%= booking.updatedAt
                              ? new Date(booking.updatedAt).toLocaleString('en-GB',{
                                  day:'2-digit', month:'short', year:'numeric',
                                  hour:'2-digit', minute:'2-digit'
                                })
                              : 'N/A' %>
                      </td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Map Preview -->
          <div class="card">
            <div class="card-header"><h3 class="card-title">Route Preview</h3></div>
            <div class="card-body p-0">
              <div id="map" style="height:400px;"></div>
            </div>
          </div>

        </div><!-- /.container -->
      </section>
    </div><!-- /.content-wrapper -->
  </div><!-- /.wrapper -->

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

  <!-- Google Maps JS API (with callback) -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=<%= googleApiKey %>&callback=initMap">
  </script>

  <script>
    function initMap() {
      // Coordinates: [lng, lat]
      const pickup = {
        lat: <%= booking.pickupLocation.coordinates[1] %>,
        lng: <%= booking.pickupLocation.coordinates[0] %>
      };
      const drop = {
        lat: <%= booking.dropLocation.coordinates[1] %>,
        lng: <%= booking.dropLocation.coordinates[0] %>
      };

      // Center map on pickup
      const map = new google.maps.Map(document.getElementById('map'), {
        center: pickup,
        zoom: 13,
      });

      // Markers
      new google.maps.Marker({
        position: pickup,
        map,
        title: 'Pickup',
      });
      new google.maps.Marker({
        position: drop,
        map,
        title: 'Drop',
        icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
      });

      // Polyline
      new google.maps.Polyline({
        path: [ pickup, drop ],
        strokeColor: '#007bff',
        strokeWeight: 4,
        map,
      });
    }
  </script>
</body>
</html>
